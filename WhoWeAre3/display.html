<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Who We Are â€“ Display</title>

  <!-- Tailwind + ×¤×•× ×˜×™× -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#8A2BE2",
            "green-correct": "#10B981",
            "red-incorrect": "#EF4444",
          },
          fontFamily: { display: ["Assistant", "sans-serif"] },
        },
      },
    };
  </script>
  <style>
    body { font-family: 'Assistant', sans-serif; }
    .flip-card { perspective: 1000px; }
    .flip-card-inner {
      position: relative; width: 100%; height: 100%;
      text-align: center; transition: transform 0.6s; transform-style: preserve-3d;
    }
    .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back {
      position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center; border-radius: 9999px;
    }
    .flip-card-front { background-color: #FBBF24; color: white; }
    .flip-card-back { transform: rotateY(180deg); color: white; background-color: #4B5563; }
    .disabled-btn { opacity: 0.5; cursor: not-allowed; }

    /* ×¨×§×¢ ×—×’×™×’×™ + ×× ×™××¦×™×” ×œ××¡×š ×”×¡×™×›×•× */
    .animate-bg {
      animation: gradientBG 8s ease infinite;
      background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #a18cd1, #fbc2eb);
      background-size: 400% 400%;
    }
    @keyframes gradientBG {
      0% {background-position:0% 50%}
      50% {background-position:100% 50%}
      100% {background-position:0% 50%}
    }
  </style>
</head>
<body class="bg-white text-gray-900">
<div class="container mx-auto p-4 md:p-8 text-center">

  <!-- ×›×•×ª×¨×ª -->
  <header class="mb-2">
    <h1 id="question" class="text-3xl md:text-4xl font-bold text-primary">â“ ××—×›×™× ×œ×©×—×§× ×™×... â“</h1>
  </header>

  <!-- ×ª×©×•×‘×•×ª -->
  <main class="mb-8">
    <div id="cardsContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6 justify-items-center"></div>
  </main>

  <!-- ×˜×™×™××¨ + ×¨×©×™××ª ××©×ª×ª×¤×™× -->
  <div class="flex flex-col md:flex-row justify-around items-center gap-8">
    <!-- ×˜×™×™××¨ -->
    <div class="relative w-32 h-32 md:w-40 md:h-40">
      <svg class="w-full h-full" viewBox="0 0 100 100">
        <circle class="text-gray-200" cx="50" cy="50" r="45" stroke="currentColor" stroke-width="10" fill="transparent"></circle>
        <circle class="text-green-500" cx="50" cy="50" r="45" stroke="currentColor" stroke-width="10"
                fill="transparent" id="timer-circle"
                stroke-dasharray="283" stroke-dashoffset="0"
                stroke-linecap="round" transform="rotate(-90 50 50)"></circle>
      </svg>
      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <span id="timer-text" class="text-4xl font-bold text-blue-600">30</span>
        <span class="text-lg text-gray-500">sec</span>
      </div>
    </div>

    <!-- ×¨×©×™××ª ××©×ª×ª×¤×™× -->
    <div class="text-right">
      <h2 class="text-2xl font-bold mb-4 flex items-center justify-end">
        <span class="material-icons text-primary text-3xl ml-2">groups</span> ××©×ª×ª×¤×™×
      </h2>
      <ul id="playersList" class="space-y-2 text-lg"></ul>
    </div>
  </div>

  <!-- ×¤×•×˜×¨: ×¨×§ ×©× ×™ ×›×¤×ª×•×¨×™× -->
  <footer class="mt-12 flex items-center justify-center gap-4">
    <button id="toggleFlipBtn"
            class="bg-primary text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-purple-700 transition-transform transform hover:scale-105">
      ×”×¦×’ ×©××•×ª â–¶ï¸
    </button>

    <button id="nextQuestionBtn"
            class="bg-gray-800 text-white font-bold py-3 px-8 rounded-full text-xl transition-all disabled-btn"
            disabled>
      ×©××œ×” ×”×‘××” â¡ï¸
    </button>
  </footer>
</div>

<!-- Firebase + ×œ×•×’×™×§×” -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  // === ×”×“×‘×™×§×™ ×›××Ÿ ××ª ××•×ª×• config ×›××• ×‘-index.html (×›×•×œ×œ databaseURL!) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDUz4oPw2kumoT9q7ONGLSGgcuYFlnc89o",
    authDomain: "who-we-are-dee11.firebaseapp.com",
    databaseURL: "https://who-we-are-dee11-default-rtdb.firebaseio.com",
    projectId: "who-we-are-dee11",
    storageBucket: "who-we-are-dee11.firebasestorage.app",
    messagingSenderId: "685866712511",
    appId: "1:685866712511:web:a41b29e6a69b8ac889350a"
  };

  // =====================================================================

  const app = initializeApp(firebaseConfig);
  const rtdb = getDatabase(app);

  // DOM
  const playersListEl = document.getElementById("playersList");
  const cardsContainerEl = document.getElementById("cardsContainer");
  const questionTitleEl  = document.getElementById("question");
  const flipBtn = document.getElementById("toggleFlipBtn");
  const nextBtn = document.getElementById("nextQuestionBtn");

  // State
  let flippedAll = false;
  let timerInterval = null;
  let uniqueQuestions = [];      // ×›×œ ×”×©××œ×•×ª ×©× ××¦××• ×‘× ×ª×•× ×™×
  let currentQuestionIndex = 0;  // ×”×©××œ×” ×”××•×¦×’×ª
  let cachedAllEntries = [];     // ×›×œ ×”×¨×©×•××•×ª ××”-DB

  // × ×™×§×•×“ ×›×•×œ×œ ×œ×›×œ ×”××©×—×§
  let totalCorrect = 0;
  let totalGuesses = 0;
  const countedQuestions = new Set(); // ×œ× ×œ×¡×¤×•×¨ ×¤×¢××™×™× ××•×ª×” ×©××œ×”

  // ×˜×™×™××¨
  function startTimer(seconds) {
    if (timerInterval) clearInterval(timerInterval);
    let timeLeft = seconds;
    const timerText = document.getElementById("timer-text");
    const timerCircle = document.getElementById("timer-circle");
    const circleLength = 2 * Math.PI * 45; // r=45

    if (!timerText || !timerCircle) return;

    timerCircle.style.strokeDasharray = circleLength;
    timerCircle.style.strokeDashoffset = 0;
    timerText.textContent = timeLeft;

    timerInterval = setInterval(() => {
      timeLeft--;
      if (timeLeft >= 0) {
        timerText.textContent = timeLeft;
        const offset = circleLength - (timeLeft / seconds) * circleLength;
        timerCircle.style.strokeDashoffset = offset;
      } else {
        clearInterval(timerInterval);
      }
    }, 1000);
  }

  // ×”×¤×™×›×ª ×›×œ ×”×›×¨×˜×™×¡×™× + ×‘×“×™×§×ª × ×™×—×•×©×™× + ×¦×‘×™×¢×” ×™×¨×•×§/××“×•×
  function toggleFlipAll() {
    const cards = document.querySelectorAll(".flip-card");
    cards.forEach(card => {
      if (flippedAll) card.classList.remove("flipped");
      else card.classList.add("flipped");
    });
    flippedAll = !flippedAll;

    // ×˜×§×¡×˜ ×›×¤×ª×•×¨
    flipBtn.textContent = flippedAll ? "×”×¦×’ ×ª×©×•×‘×•×ª â—€ï¸" : "×”×¦×’ ×©××•×ª â–¶ï¸";

    // ×œ××¤×©×¨ "×©××œ×” ×”×‘××”" ×¨×§ ××—×¨×™ ×—×©×™×¤×”
    setNextEnabled(flippedAll);

    // ×× ×—×•×©×¤×™× â€” ×œ×‘×“×•×§ × ×™×—×•×©×™× ×•×œ×¦×‘×•×¢
    if (flippedAll) {
      evaluateGuessesAndColor();
    } else {
      // ×”×—×–×¨×ª ×¦×‘×¢×™× ×œ××¦×‘ ×¨×’×™×œ ×›×©××¡×ª×™×¨×™×
      document.querySelectorAll(".flip-card-back").forEach(back => {
        back.classList.remove("bg-green-correct", "bg-red-incorrect");
        if (!back.classList.contains("bg-gray-600")) back.classList.add("bg-gray-600");
      });
    }
  }

  function setNextEnabled(on) {
    nextBtn.disabled = !on;
    nextBtn.classList.toggle("disabled-btn", !on);
  }

  // ×‘×“×™×§×ª × ×™×—×•×©×™× ×•×¦×‘×™×¢×ª ×›×œ ×›×¨×˜×™×¡: ×™×¨×•×§/××“×•× + ×¡×¤×™×¨×ª × ×™×§×•×“ ×¤×¢× ××—×ª ×œ×©××œ×”
  function evaluateGuessesAndColor() {
    const wrappers = cardsContainerEl.querySelectorAll("[data-correct-index]");

    let correctCount = 0;
    const totalCount = wrappers.length;

    wrappers.forEach(wrapper => {
      const correctIndex = Number(wrapper.getAttribute("data-correct-index")); // 1..N
      const select = wrapper.querySelector(".guess-select");
      const back = wrapper.querySelector(".flip-card-back");

      back.classList.remove("bg-green-correct", "bg-red-incorrect", "bg-gray-600");

      const chosen = Number(select?.value || 0);
      if (chosen === correctIndex) {
        correctCount++;
        back.classList.add("bg-green-correct");
      } else {
        back.classList.add("bg-red-incorrect");
      }
    });

    if (!countedQuestions.has(currentQuestionIndex)) {
      totalCorrect += correctCount;
      totalGuesses += totalCount;
      countedQuestions.add(currentQuestionIndex);
    }
  }

  // ××¢×‘×¨ ×œ×©××œ×” ×”×‘××” (××—×¨×™ ×—×©×™×¤×”)
  function goToNextQuestion() {
    if (!flippedAll) return;

    if (currentQuestionIndex === uniqueQuestions.length - 1) {
      showSummary();
      return;
    }
    currentQuestionIndex++;
    renderForCurrent();
  }

  // ×¦×™×•×¨ ×”××¡×›×™× ×œ×©××œ×” ×”× ×•×›×—×™×ª
  function renderForCurrent() {
    const q = uniqueQuestions[currentQuestionIndex] || "×©××œ×”";
    questionTitleEl.textContent = "â“ " + q + " â“";

    // ×¡×™× ×•×Ÿ ×ª×©×•×‘×•×ª ×©×œ ×”×©××œ×” ×”× ×•×›×—×™×ª
    const entries = cachedAllEntries.filter(e => (e.question || "") === q);

    // ×¨×©×™××ª ××©×ª×ª×¤×™× (1..N)
    playersListEl.innerHTML = "";
    entries.forEach((e, i) => {
      const li = document.createElement("li");
      li.textContent = `${i + 1} = ${e.name || "×× ×•× ×™××™/×ª"}`;
      playersListEl.appendChild(li);
    });

    // ×›×¨×˜×™×¡×™ ×ª×©×•×‘×•×ª: ×‘×œ×™ ××¡×¤×¨ ×¢×œ ×”×›×¨×˜×™×¡; ×ª×™×‘×ª × ×™×—×•×© 1..N; ×•×©×•××¨×™× correct-index = (i+1)
    cardsContainerEl.innerHTML = "";
    entries.forEach((e, i) => {
      const wrapper = document.createElement("div");
      wrapper.className = "flex flex-col items-center gap-3";
      wrapper.setAttribute("data-correct-index", String(i + 1)); // ×”××¡×¤×¨ ×”× ×›×•×Ÿ ×œ×”×©×•×•××”

      const optionsHtml = entries.map((_, idx) => `<option value="${idx + 1}">${idx + 1}</option>`).join("");

      wrapper.innerHTML = `
        <div class="flip-card w-32 h-32 md:w-40 md:h-40 cursor-pointer">
          <div class="flip-card-inner">
            <div class="flip-card-front shadow-lg bg-yellow-400 text-white flex items-center justify-center text-center rounded-full p-4">
              <span class="text-xl font-bold break-words">${e.answer || "â€”"}</span>
            </div>
            <div class="flip-card-back bg-gray-600 text-white flex items-center justify-center text-center rounded-full p-4">
              <span class="text-xl font-bold break-words">${e.name || "×× ×•× ×™××™/×ª"}</span>
            </div>
          </div>
        </div>

        <div class="flex flex-col items-center text-sm text-gray-700">
          <label class="font-medium mb-1">××™ ×œ×“×¢×ª×›× ×××¨/×” ××ª ×–×”?</label>
          <select class="border border-gray-300 rounded-lg px-2 py-1 text-center text-base font-semibold guess-select">
            ${optionsHtml}
          </select>
          <div class="text-[12px] text-gray-500 mt-1">×‘×—×¨×• ××¡×¤×¨ ××ª×•×š "××©×ª×ª×¤×™×"</div>
        </div>
      `;
      cardsContainerEl.appendChild(wrapper);
    });

    // ×œ××¤×¡ ×”×™×¤×•×š, ×œ×›×‘×•×ª "×©××œ×” ×”×‘××”", ×•×œ×”×¤×¢×™×œ ×˜×™×™××¨ ×—×“×©
    flippedAll = false;
    document.querySelectorAll(".flip-card").forEach(c => c.classList.remove("flipped"));
    document.querySelectorAll(".flip-card-back").forEach(back => {
      back.classList.remove("bg-green-correct", "bg-red-incorrect");
      if (!back.classList.contains("bg-gray-600")) back.classList.add("bg-gray-600");
    });
    flipBtn.textContent = "×”×¦×’ ×©××•×ª â–¶ï¸";
    setNextEnabled(false);
    startTimer(30);
  }

  // ××¡×š ×¡×™×›×•× + ×›×¤×ª×•×¨ ××™×¤×•×¡ ×¦×”×•×‘
  function showSummary() {
    const percent = totalGuesses === 0 ? 0 : Math.round((totalCorrect / totalGuesses) * 100);

    const message = percent >= 70
      ? "××™×–×” ×—×™×‘×•×¨ ×‘×§×‘×•×¦×”!!! ××œ ×ª×©×›×—×• ×©×ª××™×“ ×™×© ××§×•× ×œ×—×™×–×•×§ ×”×§×©×¨×™× ×‘×™× ×™× ×•."
      : "×§×‘×œ×• ××©×™××ª ×—×™×‘×•×¨ ×œ×—×™×–×•×§ ×”×§×©×¨";

    // ××¡×ª×™×¨×™× ××ª ×”××¤×œ×™×§×¦×™×”
    const app = document.querySelector(".container");
    if (app) app.style.display = "none";

    // ×¨×§×¢ ×—×’×™×’×™
    document.body.classList.add("animate-bg");

    // ×©×›×‘×ª ×§×•× ×¤×˜×™
    const confettiCanvas = document.createElement("canvas");
    confettiCanvas.id = "confettiCanvas";
    confettiCanvas.style.position = "fixed";
    confettiCanvas.style.top = 0;
    confettiCanvas.style.left = 0;
    confettiCanvas.style.width = "100%";
    confettiCanvas.style.height = "100%";
    confettiCanvas.style.pointerEvents = "none";
    document.body.appendChild(confettiCanvas);
    startConfetti(confettiCanvas);

    // ××¡×š ×¡×™×›×•×
    const summary = document.createElement("div");
    summary.id = "summaryScreen";
    summary.className = "fixed inset-0 flex items-center justify-center p-6 text-center";
    summary.innerHTML = `
      <div class="max-w-2xl w-full bg-white/80 backdrop-blur rounded-3xl shadow-xl p-8">
        <h2 class="text-4xl font-extrabold text-primary mb-4">ğŸŠ ×¡×™×›×•× ×”××©×—×§ ğŸŠ</h2>
        <p class="text-3xl mb-2">
          ×ª×•×¦××”:
          <span class="font-bold">${totalCorrect}</span>
          × ×›×•× ×•×ª ××ª×•×š
          <span class="font-bold">${totalGuesses}</span>
          (${percent}%)
        </p>
        <p class="text-2xl font-bold mt-2">${message}</p>

        <button id="resetBtn"
                class="mt-8 bg-yellow-400 text-gray-900 font-bold py-3 px-8 rounded-full text-xl hover:bg-yellow-500 transition-transform transform hover:scale-105">
          ××™×¤×•×¡ ××©×—×§ ğŸ”
        </button>
      </div>
    `;
    document.body.appendChild(summary);

    // ×—×™×‘×•×¨ ×”×›×¤×ª×•×¨ ×”×¦×”×•×‘ ×œ××¡×š ×”×¡×™×›×•×
    document.getElementById("resetBtn")?.addEventListener("click", resetAll);
  }

  // ×§×•× ×¤×˜×™ ×¦×‘×¢×•× ×™ ××ª××©×š
  function startConfetti(canvas) {
    const ctx = canvas.getContext("2d");
    let W = (canvas.width = window.innerWidth);
    let H = (canvas.height = window.innerHeight);

    const confettis = [];
    for (let i = 0; i < 160; i++) {
      confettis.push({
        x: Math.random() * W,
        y: Math.random() * H - H,
        r: Math.random() * 6 + 4,
        d: Math.random() * 100 + 10,
        color: `hsl(${Math.random() * 360}, 70%, 60%)`,
        tilt: Math.random() * 10 - 10,
        tiltAngleIncremental: Math.random() * 0.07 + 0.05,
        tiltAngle: 0
      });
    }

    function draw() {
      ctx.clearRect(0, 0, W, H);
      confettis.forEach(c => {
        ctx.beginPath();
        ctx.lineWidth = c.r;
        ctx.strokeStyle = c.color;
        ctx.moveTo(c.x + c.tilt + c.r / 2, c.y);
        ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 2);
        ctx.stroke();
      });
      update();
    }

    function update() {
      confettis.forEach(c => {
        c.tiltAngle += c.tiltAngleIncremental;
        c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
        c.x += Math.sin(c.d);
        c.tilt = Math.sin(c.tiltAngle) * 15;
        if (c.y > H) {
          c.x = Math.random() * W;
          c.y = -10;
        }
      });
    }

    window.addEventListener("resize", () => {
      W = canvas.width = window.innerWidth;
      H = canvas.height = window.innerHeight;
    });

    setInterval(draw, 20);
  }

  // ××™×¤×•×¡ ×›×œ×œ×™: ××•×—×§ players/, ×××¤×¡ × ×™×§×•×“ ×•××—×–×™×¨ ×œ××¡×š ×”×¨××©×™
  function resetAll() {
    if (!confirm("×œ××—×•×§ ××ª ×›×œ ×”×ª×©×•×‘×•×ª ×•×œ×”×ª×—×™×œ ××©×—×§ ×—×“×©?")) return;

    // ×›×™×‘×•×™ ×–×× ×™ ×©×œ ×›×¤×ª×•×¨×™×
    try { setNextEnabled(false); } catch {}
    flipBtn?.setAttribute("disabled", "");
    nextBtn?.setAttribute("disabled", "");
    document.getElementById("resetBtn")?.setAttribute("disabled", "");

    const playersRef = ref(rtdb, "players");

    remove(playersRef)
      .then(() => {
        // ××¤×¡ × ×™×§×•×“ ×•××¦×‘
        totalCorrect = 0;
        totalGuesses = 0;
        countedQuestions.clear();
        flippedAll = false;
        uniqueQuestions = [];
        cachedAllEntries = [];
        currentQuestionIndex = 0;

        // ×¡×’×™×¨×ª ×¡×™×›×•×/×§×•× ×¤×˜×™/×¨×§×¢
        document.getElementById("summaryScreen")?.remove();
        document.getElementById("confettiCanvas")?.remove();
        document.body.classList.remove("animate-bg");

        // ×”×—×–×¨×ª ×”××¡×š ×”×¨××©×™
        const app = document.querySelector(".container");
        if (app) app.style.display = "";

        playersListEl.innerHTML = "";
        cardsContainerEl.innerHTML = "";
        questionTitleEl.textContent = "â“ ××—×›×™× ×œ×©×—×§× ×™×... â“";
        flipBtn.textContent = "×”×¦×’ ×©××•×ª â–¶ï¸";

        // ×œ×”×—×–×™×¨ ×©×œ×™×˜×”
        flipBtn?.removeAttribute("disabled");
        nextBtn?.setAttribute("disabled", ""); // ×”×‘× ×›×‘×•×™ ×¢×“ ×—×©×™×¤×”
        startTimer(30);
      })
      .catch((err) => {
        alert("×”××™×¤×•×¡ × ×›×©×œ: " + err.message);
        document.getElementById("resetBtn")?.removeAttribute("disabled");
        flipBtn?.removeAttribute("disabled");
      });
  }

  // ×××–×™× ×™×
  flipBtn.addEventListener("click", toggleFlipAll);
  nextBtn.addEventListener("click", goToNextQuestion);

  // ×××–×™×Ÿ ×œ× ×ª×™×‘ players
  const playersRef = ref(rtdb, "players");
  onValue(playersRef, (snapshot) => {
    const data = snapshot.val();

    if (!data) {
      questionTitleEl.textContent = "××—×›×™× ×œ×©×—×§× ×™×...";
      playersListEl.innerHTML = "<li>×¢×“×™×™×Ÿ ××™×Ÿ ××©×ª×ª×¤×™×</li>";
      cardsContainerEl.innerHTML = "";
      uniqueQuestions = [];
      currentQuestionIndex = 0;
      setNextEnabled(false);
      flippedAll = false;
      flipBtn.textContent = "×”×¦×’ ×©××•×ª â–¶ï¸";
      startTimer(30);
      return;
    }

    // ×œ×¨×©×™××” ×××•×™×Ÿ ×œ×¤×™ ×–××Ÿ
    cachedAllEntries = Object.values(data).filter(Boolean);
    cachedAllEntries.sort((a, b) => (a.answeredAt || "").localeCompare(b.answeredAt || ""));

    // ×©××œ×•×ª ×™×™×—×•×“×™×•×ª ×œ×¤×™ ×¡×“×¨ ×”×•×¤×¢×”
    const setQ = new Set();
    cachedAllEntries.forEach(e => setQ.add(e.question || "×©××œ×”"));
    uniqueQuestions = Array.from(setQ);

    if (currentQuestionIndex >= uniqueQuestions.length) currentQuestionIndex = uniqueQuestions.length - 1;
    if (currentQuestionIndex < 0) currentQuestionIndex = 0;

    renderForCurrent();
  });
</script>
</body>
</html>
