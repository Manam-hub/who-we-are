<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Who We Are – Display</title>

  <!-- Tailwind + פונטים -->
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"/>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#8A2BE2",
            "green-correct": "#10B981",
            "red-incorrect": "#EF4444",
          },
          fontFamily: { display: ["Assistant", "sans-serif"] },
        },
      },
    };
  </script>
  <style>
    body { font-family: 'Assistant', sans-serif; }
    .flip-card { perspective: 1000px; }
    .flip-card-inner {
      position: relative; width: 100%; height: 100%;
      text-align: center; transition: transform 0.6s; transform-style: preserve-3d;
    }
    .flip-card.flipped .flip-card-inner { transform: rotateY(180deg); }
    .flip-card-front, .flip-card-back {
      position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden;
      display: flex; align-items: center; justify-content: center; border-radius: 9999px;
    }
    .flip-card-front { background-color: #FBBF24; color: white; }
    .flip-card-back { transform: rotateY(180deg); color: white; background-color: #4B5563; }
  </style>
</head>
<body class="bg-white text-gray-900">
<div class="container mx-auto p-4 md:p-8 text-center">

  <!-- Header -->
  <header class="mb-8">
    <h1 id="question" class="text-3xl md:text-4xl font-bold text-primary">
      ❓ מחכים לשחקנים... ❓
    </h1>
  </header>

  <!-- Cards -->
  <main class="mb-8">
    <div id="cardsContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-8 justify-items-center"></div>
  </main>

  <!-- Timer + Players -->
  <div class="flex flex-col md:flex-row justify-around items-center gap-8">
    <!-- Timer -->
    <div class="relative w-32 h-32 md:w-40 md:h-40">
      <svg class="w-full h-full" viewBox="0 0 100 100">
        <circle class="text-gray-200" cx="50" cy="50" r="45" stroke="currentColor" stroke-width="10" fill="transparent"></circle>
        <circle class="text-green-500" cx="50" cy="50" r="45" stroke="currentColor" stroke-width="10"
                fill="transparent" id="timer-circle"
                stroke-dasharray="283" stroke-dashoffset="0"
                stroke-linecap="round" transform="rotate(-90 50 50)"></circle>
      </svg>
      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <span id="timer-text" class="text-4xl font-bold text-blue-600">30</span>
        <span class="text-lg text-gray-500">sec</span>
      </div>
    </div>

    <!-- Players -->
    <div class="text-right">
      <h2 class="text-2xl font-bold mb-4 flex items-center justify-end">
        <span class="material-icons text-primary text-3xl ml-2">groups</span> משתתפים
      </h2>
      <ul id="playersList" class="space-y-2 text-lg"></ul>
    </div>
  </div>

  <!-- Footer: כפתור יחיד להפוך את כל הכרטיסים -->
  <footer class="mt-12">
    <button id="toggleFlipBtn"
            class="bg-primary text-white font-bold py-3 px-8 rounded-full text-xl hover:bg-purple-700 transition-transform transform hover:scale-105">
      הצג שמות ▶️
    </button>
  </footer>
</div>

<!-- Firebase + לוגיקה -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-database.js";

  // הדביקי כאן את אותו config בדיוק כמו ב-index.html (כולל databaseURL!)
  const firebaseConfig = {
    apiKey: "AIzaSyDUz4oPw2kumoT9q7ONGLSGgcuYFlnc89o",
    authDomain: "who-we-are-dee11.firebaseapp.com",
    databaseURL: "https://who-we-are-dee11-default-rtdb.firebaseio.com",
    projectId: "who-we-are-dee11",
    storageBucket: "who-we-are-dee11.firebasestorage.app",
    messagingSenderId: "685866712511",
    appId: "1:685866712511:web:a41b29e6a69b8ac889350a"
  };


  const app = initializeApp(firebaseConfig);
  const rtdb = getDatabase(app);

  const playersListEl = document.getElementById("playersList");
  const cardsContainerEl = document.getElementById("cardsContainer");
  const questionTitleEl = document.getElementById("question");

  let flippedAll = false;
  let timerInterval = null;
  let currentQuestionKey = null;
const layoutsByQuestion = Object.create(null);

  function startTimer(seconds) {
    if (timerInterval) clearInterval(timerInterval);
    let timeLeft = seconds;
    const timerText = document.getElementById("timer-text");
    const timerCircle = document.getElementById("timer-circle");
    const circleLength = 2 * Math.PI * 45; // r=45

    if (!timerText || !timerCircle) return;

    timerCircle.style.strokeDasharray = circleLength;
    timerCircle.style.strokeDashoffset = 0;
    timerText.textContent = timeLeft;

    timerInterval = setInterval(() => {
      timeLeft--;
      if (timeLeft >= 0) {
        timerText.textContent = timeLeft;
        const offset = circleLength - (timeLeft / seconds) * circleLength;
        timerCircle.style.strokeDashoffset = offset;
      } else {
        clearInterval(timerInterval);
      }
    }, 1000);
  }

  function toggleFlipAll() {
    const cards = document.querySelectorAll(".flip-card");
    cards.forEach(card => {
      if (flippedAll) card.classList.remove("flipped");
      else card.classList.add("flipped");
    });
    flippedAll = !flippedAll;

    const btn = document.getElementById("toggleFlipBtn");
    if (btn) btn.textContent = flippedAll ? "הצג תשובות ◀️" : "הצג שמות ▶️";
  }
  document.getElementById("toggleFlipBtn")?.addEventListener("click", toggleFlipAll);

  function render(entries) {
    // כותרת שאלה – לפי הרשומה האחרונה (אם קיימת)
    const last = entries[entries.length - 1];
    questionTitleEl.textContent = "❓ " + (last?.question || "שאלה") + " ❓";

    // רשימת משתתפים
    playersListEl.innerHTML = "";
    entries.forEach((e, i) => {
      const li = document.createElement("li");
      li.textContent = `${i + 1} = ${e.name || "אנונימי/ת"}`;
      playersListEl.appendChild(li);
    });

    // כרטיסים
    cardsContainerEl.innerHTML = "";
    entries.forEach((e, i) => {
      const wrapper = document.createElement("div");
      wrapper.className = "flex flex-col items-center gap-2";

      wrapper.innerHTML = `
        <div class="relative">
          <div class="absolute -top-2 -right-2 w-8 h-8 rounded-full bg-gray-800 text-white flex items-center justify-center text-sm">${i + 1}</div>

          <div class="flip-card w-32 h-32 md:w-40 md:h-40">
            <div class="flip-card-inner">
              <div class="flip-card-front shadow-lg bg-yellow-400 text-white flex items-center justify-center text-center rounded-full p-4">
                <span class="text-xl font-bold">${e.answer || "—"}</span>
              </div>
              <div class="flip-card-back bg-gray-600 text-white flex items-center justify-center text-center rounded-full p-4">
                <span class="text-xl font-bold">${e.name || "אנונימי/ת"}</span>
              </div>
            </div>
          </div>
        </div>
      `;
      cardsContainerEl.appendChild(wrapper);
    });

    // בכל עדכון נתונים – אפס מצב ההיפוך והכפתור, והפעל טיימר חדש
    flippedAll = false;
    document.querySelectorAll(".flip-card").forEach(c => c.classList.remove("flipped"));
    const btn = document.getElementById("toggleFlipBtn");
    if (btn) btn.textContent = "הצג שמות ▶️";

    startTimer(30);
  }

  // מאזין לנתיב players
  const playersRef = ref(rtdb, "players");
  onValue(playersRef, (snapshot) => {
    const data = snapshot.val();
    if (!data) {
      questionTitleEl.textContent = "מחכים לשחקנים...";
      playersListEl.innerHTML = "<li>עדיין אין משתתפים</li>";
      cardsContainerEl.innerHTML = "";
      flippedAll = false;
      const btn = document.getElementById("toggleFlipBtn");
      if (btn) btn.textContent = "הצג שמות ▶️";
      startTimer(30);
      return;
    }

    // ממירים לאוסף רשומות ומסדרים לפי זמן
    const entries = Object.values(data).filter(Boolean);
    entries.sort((a, b) => (a.answeredAt || "").localeCompare(b.answeredAt || ""));
    render(entries);
  });
</script>
</body>
</html>
